# version here is only relevant for the AppVeyor CI, no need to adjust
version: '{build}'

environment:
  global:
    # Example can be found here https://github.com/quantopian/zipline/blob/master/appveyor.yml
    ANACONDA_TOKEN:
      secure: "Whb/T2fL16t975pbtx8lsc38bvrzbrdmqofy8zLhKDcRPNNaFoFq2IfJWiF29kac"
    PYTHON_LOC: "C:\\Miniconda36-x64"

install:
  - call %PYTHON_LOC%\Scripts\activate.bat
  - conda config --set always_yes yes --set changeps1 no
  - conda install -y conda-build constructor anaconda-client

build_script:
  # Test are disabled (--no-test): matplotlib fails, because no writable HOME directory
  #                                AppVeyor has no HOME directory set.
  - set MPLCONFIGDIR="."
  #- conda build --old-build-string --no-test -c conda-forge -c defaults recipes\cate
  - conda build --old-build-string --no-test -c conda-forge -c defaults recipes\cate-cli
  #- conda build --old-build-string --no-test -c conda-forge -c defaults recipes\cate-util

deploy_script:
  # only publish artifacts on master branch when pushed (not from cron or PRs)
  - ps: |
      if ( $env:APPVEYOR_SCHEDULED_BUILD -eq "True" ) {
          write-output "CRON build, won't deploy to anaconda"
      } else {
          $env:conda_upload = 'true'
      }
  - ps: |
      if ([bool]$env:APPVEYOR_PULL_REQUEST_NUMBER) {
          write-output "PULL REQUEST build, won't deploy to anaconda"
      } else {
          $env:conda_upload = 'true'
      }
  - ps: |
      if ($env:APPVEYOR_REPO_BRANCH -eq 'master') {
          $env:conda_upload = 'true'
      }
  - cmd: IF "%conda_upload%"=="true" anaconda -v -t %ANACONDA_TOKEN% upload %PYTHON_LOC%\conda-bld\win-64\cate*.tar.bz2 -u ccitools --force
  - echo "Finished Artifact Deployment"
